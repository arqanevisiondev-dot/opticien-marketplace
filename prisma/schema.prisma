generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id             String          @id @default(cuid())
  email          String          @unique
  password       String
  role           UserRole        @default(OPTICIAN)
  businessName   String?
  phone          String?
  whatsapp       String?
  description    String?         @db.Text
  address        String?
  city           String?
  postalCode     String?
  latitude       Float?
  longitude      Float?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  emailCampaigns EmailCampaign[] @relation("CampaignCreator")
  optician       Optician?
  products       Product[]       @relation("UserProducts")

  @@index([latitude, longitude])
}

model Optician {
  id           String         @id @default(cuid())
  userId       String         @unique
  businessName String
  firstName    String
  lastName     String
  phone        String
  whatsapp     String?
  address      String?
  city         String?
  postalCode   String?
  latitude     Float?
  longitude    Float?
  status       OpticianStatus @default(PENDING)
  loyaltyPoints Int           @default(0)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders       Order[]
  redemptions  LoyaltyRedemption[]

  @@index([status])
  @@index([latitude, longitude])
}

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String    @unique
  description String?
  imageUrl    String?   @db.LongText
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]

  @@index([slug])
}

model Product {
  id                  String      @id @default(cuid())
  userId              String
  categoryId          String?
  name                String
  slug                String      @unique
  reference           String      @unique
  description         String?     @db.Text
  material            String?
  gender              String?
  marque              String?
  shape               String?
  color               String?
  price               Float
  salePrice           Float?
  firstOrderRemisePct Float?
  loyaltyPointsReward Int?
  images              String      @db.LongText
  inStock             Boolean     @default(true)
  isNewCollection     Boolean     @default(false)
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  orderItems          OrderItem[]
  category            Category?   @relation(fields: [categoryId], references: [id])
  user                User        @relation("UserProducts", fields: [userId], references: [id], onDelete: Cascade)
  loyaltyProducts     LoyaltyProduct[] @relation("LoyaltyProductLink")

  @@index([userId])
  @@index([categoryId])
  @@index([material])
  @@index([gender])
  @@index([marque])
  @@index([inStock])
  @@index([slug])
}

model Order {
  id                String      @id @default(cuid())
  opticianId        String
  status            OrderStatus @default(PENDING)
  source            OrderSource @default(WHATSAPP)
  whatsappMessageId String?
  whatsappFrom      String?
  totalAmount       Float       @default(0)
  currency          String      @default("DH") @db.VarChar(16)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  validatedAt       DateTime?
  optician          Optician    @relation(fields: [opticianId], references: [id], onDelete: Cascade)
  items             OrderItem[]

  @@index([opticianId])
  @@index([status])
  @@index([source])
}

model OrderItem {
  id               String          @id @default(cuid())
  orderId          String
  productId        String
  productName      String
  productReference String
  quantity         Int             @default(1)
  unitPrice        Float
  salePrice        Float?
  remisePct        Float?
  totalLine        Float
  confirmedAt      DateTime?
  confirmedBy      String?
  createdAt        DateTime        @default(now())
  status           OrderItemStatus @default(PENDING)
  order            Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product          Product         @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([status])
  @@index([productId], map: "OrderItem_productId_fkey")
}

model ProductOption {
  id        String   @id @default(cuid())
  type      String
  value     String
  createdAt DateTime @default(now())

  @@unique([type, value])
  @@index([type])
}

model Brand {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())

  @@index([name])
}

model EmailCampaign {
  id         String   @id @default(cuid())
  creatorId  String
  subject    String
  content    String   @db.Text
  targetRole String?
  sentAt     DateTime @default(now())
  recipients Int      @default(0)
  creator    User     @relation("CampaignCreator", fields: [creatorId], references: [id])

  @@index([creatorId])
  @@index([sentAt])
}

model Slide {
  id              String    @id @default(cuid())
  title           String
  subtitle        String?   @db.Text
  description     String?   @db.Text
  image           Bytes?
  imageUrl        String?   @db.LongText
  type            SlideType @default(NEWS)
  linkUrl         String?   @db.VarChar(500)
  linkText        String?   @db.VarChar(100)
  isActive        Boolean   @default(true)
  order           Int       @default(0)
  startDate       DateTime?
  endDate         DateTime?
  backgroundColor String?   @db.VarChar(20)
  textColor       String?   @db.VarChar(20)
  buttonColor     String?   @db.VarChar(20)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([isActive, order])
  @@index([startDate, endDate])
}

model LoyaltyProduct {
  id          String   @id @default(cuid())
  productId   String?
  name        String
  description String?  @db.Text
  imageUrl    String?  @db.LongText
  pointsCost  Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  product     Product? @relation("LoyaltyProductLink", fields: [productId], references: [id], onDelete: SetNull)
  redemptionItems LoyaltyRedemptionItem[]

  @@index([isActive])
  @@index([productId])
}

model LoyaltyRedemption {
  id                String               @id @default(cuid())
  opticianId        String
  status            RedemptionStatus     @default(PENDING)
  totalPoints       Int                  @default(0)
  deliveryAddress   String?              @db.Text
  notes             String?              @db.Text
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  approvedAt        DateTime?
  approvedBy        String?
  rejectedAt        DateTime?
  rejectedBy        String?
  rejectionReason   String?              @db.Text
  optician          Optician             @relation(fields: [opticianId], references: [id], onDelete: Cascade)
  items             LoyaltyRedemptionItem[]

  @@index([opticianId])
  @@index([status])
}

model LoyaltyRedemptionItem {
  id              String            @id @default(cuid())
  redemptionId    String
  loyaltyProductId String
  productName     String
  quantity        Int               @default(1)
  pointsCost      Int
  totalPoints     Int
  imageUrl        String?           @db.LongText
  createdAt       DateTime          @default(now())
  redemption      LoyaltyRedemption @relation(fields: [redemptionId], references: [id], onDelete: Cascade)
  loyaltyProduct  LoyaltyProduct    @relation(fields: [loyaltyProductId], references: [id])

  @@index([redemptionId])
  @@index([loyaltyProductId])
}

model SystemSettings {
  id                      String   @id @default(cuid())
  key                     String   @unique
  value                   String
  description             String?  @db.Text
  updatedAt               DateTime @updatedAt

  @@index([key])
}

enum UserRole {
  ADMIN
  OPTICIAN
}

enum OpticianStatus {
  PENDING
  APPROVED
  REJECTED
}

enum OrderItemStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum OrderStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum OrderSource {
  WHATSAPP
  MANUAL
}

enum SlideType {
  NEWS
  PRODUCT
  PROMOTION
  ANNOUNCEMENT
}

enum RedemptionStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}
